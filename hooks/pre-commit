#!/usr/bin/env bash
# ==============================================================================
# Git pre-commit hook for automatically adding signatures to code files
#
# This hook runs before every commit and adds professional signatures to
# files that don't already have them.
#
# Installation:
#   1. Copy this file to ~/.git-hooks/pre-commit
#   2. Make it executable: chmod +x ~/.git-hooks/pre-commit
#   3. Configure Git: git config --global core.hooksPath ~/.git-hooks
# ==============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}Error: Python 3 is required but not found${NC}" >&2
    exit 1
fi

# Check if signature tool is available
if ! python3 -c "import signature_tool" 2>/dev/null; then
    # Try to find it in common locations
    if [ -f "$HOME/bin/add-signatures" ]; then
        SIGNATURE_CMD="$HOME/bin/add-signatures"
    elif [ -f "$(dirname "$0")/../../src/signature_tool/cli.py" ]; then
        # Running from repo hooks directory
        SIGNATURE_CMD="python3 $(dirname "$0")/../../src/signature_tool/cli.py"
    else
        echo -e "${YELLOW}Warning: Signature tool not found. Skipping signature check.${NC}" >&2
        echo -e "${YELLOW}To install: pip install signature-tool${NC}" >&2
        exit 0  # Don't block commit
    fi
else
    SIGNATURE_CMD="python3 -m signature_tool.cli"
fi

# Check if config exists
if [ ! -f "$HOME/.signature.json" ]; then
    echo -e "${YELLOW}Warning: Signature config not found at ~/.signature.json${NC}" >&2
    echo -e "${YELLOW}Skipping signature check. Run install.sh to set up.${NC}" >&2
    exit 0  # Don't block commit
fi

# Get list of staged files (Added, Copied, Modified)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    # No staged files, nothing to do
    exit 0
fi

# Create temporary file list
TEMP_FILE=$(mktemp)
echo "$STAGED_FILES" > "$TEMP_FILE"

# Track if any files were modified
MODIFIED=0

# Process each staged file
while IFS= read -r file; do
    # Skip if file doesn't exist (might be deleted)
    if [ ! -f "$file" ]; then
        continue
    fi

    # Check if file needs signature
    # Run signature tool in check mode (we'll implement this)
    if python3 -c "
import sys
from pathlib import Path
sys.path.insert(0, '$(dirname "$0")/../../src')
from signature_tool.config import load_config
from signature_tool.processor import FileProcessor

try:
    config = load_config()
    processor = FileProcessor(config.to_dict())
    file_path = Path('$file')

    # Check if file needs processing
    if processor.process_file(file_path):
        sys.exit(0)  # File was modified
    else:
        sys.exit(1)  # File was skipped
except Exception as e:
    print(f'Error: {e}', file=sys.stderr)
    sys.exit(1)
" 2>/dev/null; then
        # File was modified, re-stage it
        git add "$file"
        MODIFIED=1
        echo -e "${GREEN}âœ“${NC} Added signature to: $file"
    fi
done < "$TEMP_FILE"

# Clean up
rm "$TEMP_FILE"

# Inform user if files were modified
if [ $MODIFIED -eq 1 ]; then
    echo -e "${GREEN}Signatures added to staged files${NC}"
fi

exit 0
